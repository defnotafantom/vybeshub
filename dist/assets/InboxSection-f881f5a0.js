import{r as n,s as x,j as s,c as _}from"./index-7b5a1508.js";const M=({user:l,uploadFile:w})=>{const[j,h]=n.useState([]),[u,f]=n.useState({}),[t,y]=n.useState(null),[N,o]=n.useState([]),[g,p]=n.useState(""),[d,b]=n.useState(null),C=[{id:"1",username:"Alice",avatar_url:"https://i.pravatar.cc/150?img=32"},{id:"2",username:"Bob",avatar_url:"https://i.pravatar.cc/150?img=12"},{id:"3",username:"Charlie",avatar_url:"https://i.pravatar.cc/150?img=22"}],m={1:[{id:"m1",sender_id:"1",receiver_id:l.id,content:"Ciao! Come va?",created_at:new Date}],2:[{id:"m3",sender_id:"2",receiver_id:l.id,content:"Guarda questa immagine",file_url:"https://picsum.photos/200",created_at:new Date}],3:[{id:"m4",sender_id:"3",receiver_id:l.id,content:"Video test",file_url:"https://www.w3schools.com/html/mov_bbb.mp4",created_at:new Date}]};n.useEffect(()=>{(async()=>{const{data:r,error:a}=await x.from("profiles").select("*").neq("id",l.id);if(!a&&r.length>0){h(r);const c={};r.forEach(i=>{c[i.id]=null}),f(c)}else{h(C);const c={};Object.keys(m).forEach(i=>{c[i]=m[i][m[i].length-1]}),f(c)}})()},[]);const S=async e=>{const{data:r,error:a}=await x.from("messages").select("*").or(`and(sender_id.eq.${l.id},receiver_id.eq.${e}),and(sender_id.eq.${e},receiver_id.eq.${l.id})`).order("created_at",{ascending:!0});!a&&r.length>0?o(r):m[e]?o(m[e]):o([])},v=async()=>{if(!g.trim()&&!d)return;let e=null;d&&(e=await w(d.file,"messages"));const r={id:`temp_${Date.now()}`,sender_id:l.id,receiver_id:t.id,content:g,file_url:e,created_at:new Date};o(a=>[...a,r]),p(""),b(null)};return n.useEffect(()=>{const e=x.channel("messages").on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},r=>{const a=r.new;t&&(a.sender_id===t.id||a.receiver_id===t.id)&&o(i=>[...i,a]);const c=a.sender_id===l.id?a.receiver_id:a.sender_id;f(i=>({...i,[c]:a}))}).subscribe();return()=>x.removeChannel(e)},[t]),s.jsxs("div",{className:"flex w-full h-[80vh] gap-4",children:[s.jsx("div",{className:"w-72 flex flex-col border-r border-gray-300 p-2 space-y-2 overflow-y-auto",children:j.map(e=>s.jsxs("button",{onClick:()=>{y(e),S(e.id)},className:_("flex items-center gap-3 p-2 rounded-xl hover:bg-gray-200 transition-colors",(t==null?void 0:t.id)===e.id?"bg-gray-300":"bg-gray-100/50"),children:[s.jsx("img",{src:e.avatar_url||"https://i.pravatar.cc/40",alt:e.username,className:"w-12 h-12 rounded-full"}),s.jsxs("div",{className:"flex flex-col flex-1 text-left",children:[s.jsx("span",{className:"font-bold",children:e.username}),u[e.id]&&s.jsx("span",{className:"text-sm text-gray-600 truncate",children:u[e.id].file_url?u[e.id].file_url.match(/\.(mp4|webm|mov)$/i)?"ðŸ“¹ Video":"ðŸ–¼ï¸ Immagine":u[e.id].content})]})]},e.id))}),s.jsx("div",{className:"flex-1 flex flex-col bg-gray-100/80 backdrop-blur-xl rounded-3xl shadow-2xl p-4 border border-blue-200/40",children:t?s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"flex items-center gap-3 mb-4 border-b border-gray-300 pb-2",children:[s.jsx("img",{src:t.avatar_url,alt:t.username,className:"w-12 h-12 rounded-full"}),s.jsx("span",{className:"font-bold text-lg",children:t.username})]}),s.jsx("div",{className:"flex-1 overflow-y-auto p-2 space-y-2",children:N.map(e=>s.jsxs("div",{className:_("max-w-xs p-3 rounded-2xl break-words",e.sender_id===l.id?"bg-blue-500 text-white ml-auto":"bg-gray-200 text-gray-800 mr-auto"),children:[e.file_url?e.file_url.match(/\.(mp4|webm|mov)$/i)?s.jsx("video",{src:e.file_url,controls:!0,className:"rounded-lg max-w-full"}):s.jsx("img",{src:e.file_url,alt:"msg",className:"rounded-lg max-w-full"}):e.content,e.content&&s.jsx("p",{className:"mt-1",children:e.content}),s.jsx("span",{className:"text-xs text-gray-500 mt-1 block",children:new Date(e.created_at).toLocaleTimeString()})]},e.id))}),s.jsxs("div",{className:"flex gap-2 mt-2",children:[s.jsx("input",{type:"text",placeholder:"Scrivi un messaggio...",value:g,onChange:e=>p(e.target.value),onKeyDown:e=>e.key==="Enter"&&v(),className:"flex-1 p-3 rounded-2xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-300"}),s.jsx("input",{type:"file",accept:"image/*,video/*",onChange:e=>{e.target.files&&e.target.files[0]&&b({file:e.target.files[0],url:URL.createObjectURL(e.target.files[0])})}}),s.jsx("button",{onClick:v,className:"px-4 py-2 rounded-2xl bg-blue-500 hover:bg-blue-600 text-white font-semibold transition-colors",children:"Invia"})]}),d&&s.jsx("div",{className:"mt-2",children:d.file.type.startsWith("image/")?s.jsx("img",{src:d.url,alt:"preview",className:"w-32 h-32 object-contain rounded-2xl border border-gray-200 shadow-sm"}):s.jsx("video",{src:d.url,controls:!0,className:"w-32 h-32 object-contain rounded-2xl border border-gray-200 shadow-sm"})})]}):s.jsx("p",{className:"text-gray-500 text-center mt-10",children:"Seleziona un contatto per iniziare la chat"})})]})};export{M as default};
